(function(){"use strict";function _(e){return new Worker(""+new URL("IsochronesShapeWorker-FFDiNG38.js",self.location.href).href,{name:e==null?void 0:e.name})}let i,r=0,d,m,h;self.onmessage=async function(e){const a=e.data.method;if(a=="set-canvas")i=e.data.canvas;else if(a=="update-data"){const t=e.data.index,s=e.data.data,o=e.data.kilometersPerSecond,l=e.data.maxSeconds,n=e.data.circleResolution;r=t,m=void 0,h=void 0,C().postMessage({method:"set-data",index:r,data:s,kilometersPerSecond:o,maxSeconds:l,circleResolution:n})}else if(a=="set-max-display-level"){if(d!==void 0){const t=e.data.displayLevel;d.postMessage({method:"set-max-level",level:t})}}else if(a=="render-canvas"){if(!i)return;const t=e.data.boundingBox,s=e.data.color,o=e.data.dimensions,l=e.data.level;i.width=o[0],i.height=o[1];const n=i.getContext("2d");if(!n)return;const c=R(t,o);if(n.fillStyle=s,n.clearRect(0,0,o[0],o[1]),l=="OVERLAY_RECTS")k(n,c);else if(l=="OVERLAY_CIRCLES"){const f=p(t);E(n,c,f)}else console.log(`Cannot render level ${l}`)}};function R(e,a){return t=>{const s=Math.round((t[0]-e._sw.lng)/(e._ne.lng-e._sw.lng)*a[0]),o=Math.round((e._ne.lat-t[1])/(e._ne.lat-e._sw.lat)*a[1]);return[s,o]}}function p(e){return a=>{if(!a.bbox)return!1;const t=a.bbox;return e._sw.lat<=t[3]&&t[1]<=e._ne.lat&&e._sw.lng<=t[2]&&t[0]<=e._ne.lat}}function k(e,a){m!==void 0&&m.forEach(t=>{e.save();const s=a([t._sw.lng,t._sw.lat]),o=a([t._ne.lng,t._ne.lat]),l=o[0]-s[0],n=o[1]-s[1];e.fillRect(s[0],s[1],l+1,n+1),e.restore()})}function E(e,a,t){h!==void 0&&h.filter(t).forEach(s=>{e.save();const o=s.bbox,l=a([o[0],o[1]]),n=a([o[2],o[3]]),c=n[0]-l[0],f=n[1]-l[1];if(c<2&&f<2)e.fillRect(l[0],l[1],c+1,f+1);else{e.beginPath();const u=s.geometry.coordinates[0],v=a(u[0]);e.moveTo(v[0],v[1]);for(let g=0;g<u.length;++g){const w=a(u[g]);e.lineTo(w[0],w[1])}e.clip(),e.fillRect(l[0],l[1],c+1,f+1)}e.restore()})}function C(){return d==null||d.terminate(),d=new _,d.onmessage=e=>{const a=e.data.method;switch(a){case"update-shape":{const t=e.data.index;if(t<r){console.log(`Got stale index from shape worker (Got ${t}, expected ${r})`);return}const s=e.data;switch(s.level){case"OVERLAY_RECTS":m=s.data,self.postMessage({method:"update-display-level",index:r,level:s.level});break;case"OVERLAY_CIRCLES":h=s.data,self.postMessage({method:"update-display-level",index:r,level:s.level});break;case"GEOMETRY_CIRCLES":{const o=s.data;self.postMessage({method:"update-display-level",index:r,level:s.level,geometry:o})}break;default:console.log(`Unknown message '${s}`)}}break;default:console.log(`Unknown method '${a}'`)}},d}})();
